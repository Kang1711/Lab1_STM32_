/*
 * fsm_system.c
 *
 *  Created on: Nov 11, 2024
 *      Author: Ngo Truc Linh
 */
#include "fsm_system.h"
#include "fsm_automatic.h"
#include "global.h"
#include "button.h"

void RunSystem(){
	switch (status) {
		case INIT:
			set_traffic();
			status = NORMAL_MODE;
			setTimer2(500);
			setTimer3(500);
			break;
		case NORMAL_MODE:
			if(timer2_flag){
				auto_traffic();
				setTimer2(1000);
			}
			display_7SEG(counter);
			if(timer3_flag){
				counter++;
				if(counter > 1){
					counter = 0;
				}
				setTimer3(500);
			}
			if(Button1IsPressed()){
				status = MODIFY_RED_MODE;
				setTimer1(500);
				setTimer3(500);
				tatLED();
			}
			break;
		case MODIFY_RED_MODE:
			if(Button2IsPressed()){
				time_red[1]++;
				if(time_red[1] > 9){
					time_red[0]++;
					time_red[1] = 0;
					if(time_red[0] > 9 )
						time_red[0] = 0;
				}
			}
			if(timer1_flag){
				led_buffer[0] = 0;
				led_buffer[1] = 2;
				led_buffer[2] = time_red[0];
				led_buffer[3] = time_red[1];
				display_7SEG(count);
				count++;
				if(count > 1){
					count = 0;
				}
				setTimer1(500);
			}
			if(timer3_flag){
				HAL_GPIO_TogglePin(GPIOB, ra_Pin|rb_Pin);
				setTimer3(500);
			}
			if(Button1IsPressed()){
				status = MODIFY_YELLOW_MODE;
				setTimer1(500);
				setTimer3(500);
				tatLED();
			}
			if(Button3IsPressed()){
				count_red_row[0] = time_red[0];
				count_red_row[1] = time_red[1];
				count_red_column[0] = time_red[0];
				count_red_column[1] = time_red[1];
				status = NORMAL_MODE;
			}
			break;
		case MODIFY_YELLOW_MODE:
			if(Button2IsPressed()){
				time_yellow[1]++;
				if(time_yellow[1] > 9){
					time_yellow[0]++;
					time_yellow[1] = 0;
					if(time_yellow[0] > 9 )
					time_yellow[0] = 0;
				}
			}
			if(timer1_flag){
				led_buffer[0] = 0;
				led_buffer[1] = 3;
				led_buffer[2] = time_yellow[0];
				led_buffer[3] = time_yellow[1];
				display_7SEG(count);
				count++;
				if(count > 1){
					count = 0;
				}
				setTimer1(500);
			}
			if(timer3_flag){
				HAL_GPIO_TogglePin(GPIOB, ya_Pin|yb_Pin);
				setTimer3(500);
			}
			if(Button1IsPressed()){
				status = MODIFY_GREEN_MODE;
				setTimer1(500);
				setTimer3(500);
				turnOffAllLed();
			}
			if(Button3IsPressed()){
				count_yellow_row[0] = time_yellow[0];
				count_yellow_row[1] = time_yellow[1];
				count_yellow_column[0] = time_yellow[0];
				count_yellow_column[1] = time_yellow[1];
				status = NORMAL_MODE;
			}
			break;
		case MODIFY_GREEN_MODE:
			if(Button2IsPressed()){
				time_green[1]++;
				if(time_green[1] > 9){
					time_green[0]++;
					time_green[1] = 0;
					if(time_green[0] > 9 )
					time_green[0] = 0;
				}
			}
			if(timer1_flag){
				led_buffer[0] = 0;
				led_buffer[1] = 4;
				led_buffer[2] = time_green[0];
				led_buffer[3] = time_green[1];
				display_7SEG(count);
				count++;
				if(count > 1){
					count = 0;
				}
				setTimer1(500);
			}
			if(timer3_flag){
				HAL_GPIO_TogglePin(GPIOB, ga_Pin|gb_Pin);
				setTimer3(500);
			}
			if(Button1IsPressed()){
				status = NORMAL_MODE;
				setTimer2(500);
				setTimer1(500);
			}
			if(Button3IsPressed()){
				count_green_row[0] = time_green[0];
				count_green_row[1] = time_green[1];
				count_green_column[0] = time_green[0];
				count_green_column[1] = time_green[1];
				status = NORMAL_MODE;
			}
			break;
		default:
			break;
	}
}



